参考：[互联网协议入门](http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html)

# 概述
互联网的实现是分层的，以下基于五层
![osi](../assets/osi.png)  
没一层都定义了很多协议，总称"互联网协议"(Internet Protocol
Suite)，他们是互联网的**核心**

## 1. 实体层
也叫**物理层**，是吧电脑连接起来的物理手段，主要规定了网络的一些电气特性，作用是传送0和1(bit)的电信号。

## 2. 链路层
确定物理层比特流的分组方式  
以太网(Ethernet)协议规定：一组电信号构成一个数据包，叫做'帧'(Frame)，每一帧分成两个部分：标头(Head)和数据(Data)
- 标头：包含数据包的一些说明项，如发送者、接受者、数据类型等  
固定18字节
- 数据：数据包的具体内容
大于46字节，小于1500字节  
如果数据很长，必须分割成多个帧进行发送

### MAC地址
以太网数据包的标头的发送者和接受者的信息，通过MAC地址标识  
MAC地址，长度48个二进制，通常表示为12个十六进制数

### 广播(broadcasting)
数据包准确送到接受方的方式  
以太网采用了很"原始"的方式，它不把数据包准确发送到接收方，而是向笨网络内的所有计算机发送，让没太计算机自己判断，是否为接收方。  

## 3. 网络层
### 由来
理论上，依靠MAC地址，网卡就可以相互定位了，但是，广播方式发送数据包，效率低，范围局限在发送者所在的子网络  
网络层引进了一套新的地址(网络地址)，能够区分不同的计算机是否属于同一个子网络  
用以区分MAC地址是否出于同一个子网络，如果是同一个就采用广播方式发送，否则就采用"路由"方式发送
> 路由：如何向不通的子网络奋发数据包   

网络地址确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡

### IP协议
规定网络地址的协议，它所定义的地址就是IP地址  
IP地址范围0.0.0.0 ~ 255.255.255.255  
一个IP地址分为两部分：  
- 前一部分代表网络，判断是不是在一个子网络，配合子网掩码(subnet mask)
- 后一部分代表主机

### IP数据包
IP数据包直接被放进了以太网的数据包的"数据"部分  
IP数据包也分为"标头"和"数据"部分
- 标头：版本、长度、IP地址等信息，长度为20~60字节
- 数据：IP数据包的具体内容
它放进以太网数据包后，以太网数据包就变成了下面这样
![ethernet packet](../assets/ethernet_packet.png)

### ARP协议
因为IP数据包是放在以太网数据包里发送的，所以对方的MAC地址和IP地址是需要的  
一般，对方的IP地址是已知的，需要的是MAC地址
1. 如果两台主机在一个子网络，我们可以用ARP协议，得到对方的MAC地址  
ARP发出一个数据包(包含在以太网数据包中)，其中包含它所要查询的主机的IP地址，而MAC地址填的是FF:FF:FF:FF:FF:FF，表示这事一个"广播"地址，它所在的子网络的每一台主机都会接受这个数据包，与自己的IP相比较，如果相同就会做出回复，向对方报告自己的MAC地址，否则丢弃
2.两台不在一个子网络，那么是没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"(gateway)，让网关去处理

## 4. 传输层
同一台主机上有许多程序都需要使用网络，端口(port)予以区分，端口其实就是每一个使用网卡的程序的编号，每个数据包都发到主机的特定端口  
端口是0~65535(2^16个)之间的一个数  
传输层的功能就是建立"端口到端口"的通信  
相比之下，网络层的功能是建立"主机到主机"的通信  
只要确定主机和端口，就能实现程序之间的交流  
Unix 把主机+端口叫"套接字"(socket)

### UDP
要在数据包中加入端口信息，就需要新的协议。最简单的实现就是UDP协议，几乎就是在数据前面加上端口号  
UDP数据包：
- 标头：定义了发出端口和接收端口
- 数据：具体的内容  
UDP数据包放入IP数据包的"数据"部分，所以现在整个以太网数据包变成了下面这样
![UDP](../assets/udp_packet.png)  
UDP数据包非常简单，"标头"部分一共只有8个字节，总长度不超过65,535字节，正好放一个IP数据包

### TCP
UDP简单，但是可靠性差，一旦数据包发出，无法知道对方是否收到  
TCP弥补，TCP非常复杂，可以近似认为是有确认机制的UDP，每发出一个数据包都要求确认，如果有一个数据包丢失，就收不到确认，发送方就知道需要重新发这个包了  

TCP可以确认数据不会遗失，但是缺点是过程复杂，实现困难，消耗资源  

TCP数据包和UDP数据包一样，都是内嵌在IP数据包的"数据"部分，TCP数据包没有长度限制，但是为了保证网络效率，通常TCP数据包的长度不会超过IP数据包的长度，确保单个TCP数据包不必再分割

## 5. 应用层
应用层收到"传输层"的数据，按照实现规定好的格式解读分门别类的数据。  
**应用层的作用就是规定应用程序的数据格式**  
举例：
TCP协议可以为各种程序传递数据，如Email、WWW、FTP等，那么必须有不同协议规定他么的数据的格式，这些应用程序协议就构成了"应用层"  
这是最高的一层，直接面对用户，它的数据就放在TCP数据包的数据部分。英雌，现在以太网的数据包变成了下面这样：
![final](../assets/final_packet.png)
